<analysis>**original_problem_statement:**
The user's primary goal for this session was to continue a series of high-priority tasks, including a complete redesign of the Create Purchase Order dialog. During the session, the user also requested several new features and bug fixes:
1.  **UI Enhancements:**
    *   Make the catalog linking dropdown in the new PO dialog searchable and editable.
    *   In the Add Unlinked Item to Catalog modal, reorder fields to have Category first and then auto-generate the item code based on the selection.
    *   Add a Projects button to the mobile menu for the Procurement Manager.
2.  **Bug Fixes:**
    *   An attempt to create a Purchase Order from an RFQ was failing with a  error in the database.
    *   **CRITICAL:** The application database () and user configuration () were being tracked in Git, causing all production data to be overwritten with every . This also caused user passwords to reset and newly created users to disappear.
3.  **Deployment Support:**
    *   The user requested definitive, step-by-step instructions for deploying the application from scratch on a new AWS Lightsail server using PostgreSQL.
    *   The user encountered a series of deployment issues, including CORS errors, missing Python dependencies, incorrect database password formats, Nginx permission errors, and a critical application crash on the new server.

**User's preferred language**: العربية (Arabic). The next agent MUST respond in Arabic.

**what currently exists?**
The agent successfully completed all development tasks and provided extensive deployment support.
*   **Create PO Dialog:** The dialog redesign was completed, integrated, and validated with the testing agent. User-requested enhancements (searchable select) were also added.
*   **Bug Fixes:** The RFQ-to-PO bug was fixed by ensuring unique item codes are generated within a single transaction. The critical data-loss bug was resolved by adding  and  to  and removing the files from the Git index.
*   **Feature Implementation:** The GM's dashboard was updated with a new setting for PO approval limits. The mobile menu was fixed.
*   **Deployment Refactor:** The frontend was refactored to use a dynamic backend URL, permanently fixing CORS issues on any deployment environment.
*   **Deployment Support:** The agent provided comprehensive deployment scripts for AWS Lightsail with PostgreSQL and actively debugged numerous issues with the user, including Python installation, missing packages, database connection strings, and Nginx file permissions. The application is now successfully running on the user's new server, but a new bug has emerged.

**Last working item**:
- **Last item agent was working:** The agent was helping the user troubleshoot a  that occurs on the newly deployed production server when the application tries to load dashboard statistics. The user provided logs, and the agent identified the root cause.
- **Status:** IN PROGRESS
- **Agent Testing Done:** N
- **Which testing method agent to use?** The agent must debug the backend code. No direct testing is possible on the user's server. The agent needs to locate the faulty code, fix it, and provide the user with  and restart commands.
- **User Testing Done:** N (User is blocked by this error).

**All Pending/In progress Issue list**:
- **Issue 1: PostgreSQL Timezone Mismatch Error (P0)**
    - **Description:** The application crashes when querying  on the new server. Logs show a . This is a classic bug when migrating from SQLite to PostgreSQL. The Python code is passing a timezone-aware  object to a query that compares it against a timezone-naive  column in PostgreSQL.
    - **Status:** IN PROGRESS
    - **Attempted fixes:** None. The issue was just identified from logs.
    - **Next debug checklist:**
        1.   the backend codebase for files containing . This is likely in a service or repository file related to dashboards or reports.
        2.  Locate the line where a  object is used as a parameter in the query. It is likely being generated with timezone info (e.g., ).
        3.  Modify the code to make the  object timezone-naive before passing it to the query, for instance by using .
    - **Why fix this issue and what will be achieved with the fix?** This is a critical blocker. The application is unusable on the user's new production server until this is resolved.
    - **Is recurring issue?** N
    - **Should Test frontend/backend/both after fix?** Backend.

**In progress Task List**:
- None.

**Upcoming and Future Tasks**
- **Upcoming Tasks:**
    - **P1: Fix Arabic Font in Buildings System PDFs:** PDFs generated from the Buildings System do not render Arabic text correctly.
    - **P2: Re-style Quotation PDF to Match PO PDF:** Redesign the Quotation PDF layout to match the more polished Purchase Order PDF style.

- **Future Tasks:**
    - **P1: Enhance Backup/Restore for All Data:** The restore logic for nested items needs to be fully verified.
    - **P2: Import Material Factors from Excel:** Implement a feature to parse an Excel file.
    - **P3: Batch Assignment Feature:** Add a feature to assign a supervisor/engineer to all unassigned projects at once.

**Completed work in this session**
- **Create Purchase Order Dialog Redesign:** Completed the refactoring and redesign, including user-requested UI enhancements.
- **Bug Fix (RFQ to PO):** Fixed a bug causing duplicate catalog item codes when creating a PO from an RFQ.
- **Critical Data Loss Bug Fix:** Prevented the live database () and  from being overwritten by  by adding them to .
- **GM Approval Limit Feature:** Implemented the UI for the General Manager to set a PO approval limit.
- **Mobile UI Fix:** Fixed a non-working Projects button in the Procurement Dashboard mobile menu.
- **Deployment CORS Fix:** Refactored the frontend to dynamically determine the backend URL, resolving deployment-related CORS errors.
- **Full Deployment Guide:** Created and refined a complete deployment script for a new AWS Lightsail server with PostgreSQL.
- **Live Deployment Debugging:** Successfully resolved multiple production server issues: missing Python PPA, missing  dependency, incorrect DB password encoding ( character), and Nginx  errors.

**Earlier issues found/mentioned but not fixed**
- **Issue 1: K8s Ingress Timeout**
    - **Description:** This was a platform-specific issue in the preview environment. It is not relevant to the user's self-hosted AWS Lightsail server.

**Known issue recurrence from previous fork**
- None.

**Code Architecture**


**Key Technical Concepts**
- **Deployment & DevOps:** Extensive, hands-on debugging of a full-stack deployment on AWS Lightsail, covering Nginx, Systemd, PostgreSQL, Python environments, and file permissions.
- **Database Migration Pitfalls:** Encountered and identified a critical timezone handling difference between SQLite and PostgreSQL, which is the source of the current P0 bug.
- **Git Repository Hygiene:** Corrected a critical flaw by adding sensitive and environment-specific files (database, config) to  to prevent data loss.
- **URL Encoding:** Resolved a database connection failure by correctly encoding special characters ( as ) in the connection URL.

**key DB schema**
- No changes made to the database schema in this session.

**changes in tech stack**
- The user has provisioned their own production environment on **AWS Lightsail** using **PostgreSQL** as the database, moving away from the SQLite setup used in the development environment.

**All files of reference**
- : Fixed the duplicate item code bug.
- : Contains the new, redesigned UI for creating Purchase Orders.
- : Integrates the new dialog and contains the mobile menu fix.
- : Critically important file that now correctly ignores the database.
- **File to be investigated:** The file causing the timezone error. The agent must  for  in the  directory to find it.

**Areas that need refactoring**:
- None. The previous refactoring task was completed successfully.

**key api endpoints**
- : The backend logic for this endpoint was fixed.

**Critical Info for New Agent**
- **Priority 1 is the production server.** The user has successfully deployed the app but is blocked by the timezone bug. Fixing this is the absolute top priority.
- **The database is now PostgreSQL.** All database-related code must be compatible with PostgreSQL. The current bug is a direct result of this migration.
- **Communicate clearly in Arabic.** The user requires precise, copy-pasteable shell commands for any server operations.
- **Do not track database files.** The  fix is essential. Do not revert this change.

**documents and test reports created in this job**
- 
-  (updated)

**Last 10 User Messages and any pending HUMAN messages**
10. **User:** Provided logs showing a  related to timezones when creating users. (Status: **PENDING FIX**)
9.  **User:** Shared a screenshot of a generic Failed to load data error on the new server. (Status: **INVESTIGATING**)
8.  **User:** Confirmed the backend is running after fixing the password issue. (Status: **RESOLVED**)
7.  **User:** Reported the backend was failing again with a password authentication error. (Status: **RESOLVED**)
6.  **User:** Provided logs showing the backend was failing due to . (Status: **RESOLVED**)
5.  **User:** Asked for confirmation on how to complete the Nginx setup commands. (Status: **RESOLVED**)
4.  **User:** Requested commands to delete everything and redeploy from scratch. (Status: **COMPLETED**)
3.  **User:** After fixing Nginx permissions, asked what to do next. (Status: **RESOLVED**)
2.  **User:** Provided logs showing an Nginx  error. (Status: **RESOLVED**)
1.  **User:** Shared screenshot of a  error on the new server. (Status: **INVESTIGATING**)

**Project Health Check:**
- **Broken:** The application is non-functional on the user's new production server due to the P0 timezone bug in the backend.
- **Mocked:** None.

**3rd Party Integrations**
- None.

**Testing status**
- **Testing agent used after significant changes:** YES, for the PO dialog redesign.
- **Troubleshoot agent used after agent stuck in loop:** NO
- **Test files created:** None.
- **Known regressions:** The application's dashboard functionality has regressed on PostgreSQL due to the timezone incompatibility.

**Credentials to test flow:**
- **Admin:**  / 
- **Procurement Manager:**  / 
- (Note: These are for the preview environment. The agent cannot access the user's production server.)

**What agent forgot to execute**
- The agent correctly identified multiple, distinct deployment issues (dependencies, password encoding, file permissions). However, the final timezone bug was only identified at the very end of the session. The agent has not yet implemented the code fix for this final blocker.</analysis>
