# Architecture Guide - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø¯

## ğŸ“ Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Frontend                              â”‚
â”‚                    (React + Vite)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      API Layer                               â”‚
â”‚              /api/v2/* (FastAPI Routes)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    Service Layer                             â”‚
â”‚           Business Logic & Orchestration                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  Repository Layer                            â”‚
â”‚              Data Access & Persistence                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      Database                                â”‚
â”‚                    (PostgreSQL)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ—ï¸ Layer Responsibilities

### Routes Layer (`/routes/v2_*.py`)
- âœ… HTTP request/response handling
- âœ… Authentication & authorization
- âœ… Input validation (Pydantic models)
- âœ… Response formatting
- âŒ NO direct database access
- âŒ NO business logic

### Service Layer (`/app/services/*.py`)
- âœ… Business logic
- âœ… Orchestration of multiple repositories
- âœ… Data transformation
- âŒ NO FastAPI dependencies (Request, Depends)
- âŒ NO HTTP-specific code

### Repository Layer (`/app/repositories/*.py`)
- âœ… Database CRUD operations
- âœ… Query building
- âœ… Data persistence
- âŒ NO business logic
- âŒ NO HTTP code

---

## ğŸ“¦ Data Serialization Rules

### Rule 1: Never return ORM models directly
```python
# âŒ BAD
@router.get("/items")
async def get_items(service: Service):
    return await service.get_all()  # Returns ORM models

# âœ… GOOD
@router.get("/items")
async def get_items(service: Service):
    items_orm = await service.get_all()
    return [item_to_response(i).model_dump() for i in items_orm]
```

### Rule 2: Use Response Models or helper functions
```python
# Define response model
class ItemResponse(BaseModel):
    id: str
    name: str
    created_at: Optional[str] = None

# Helper function
def item_to_response(item: ItemORM) -> ItemResponse:
    return ItemResponse(
        id=str(item.id),
        name=item.name,
        created_at=item.created_at.isoformat() if item.created_at else None
    )
```

### Rule 3: Datetime handling
```python
from app.config import utc_now, to_iso_string

# Creating timestamps
created_at = utc_now()

# Converting to ISO string for JSON
response = {
    "created_at": to_iso_string(item.created_at)
}
```

---

## ğŸ”¢ Naming Conventions

### Routes
- `GET /items` â†’ `get_items()` or `list_items()`
- `GET /items/{id}` â†’ `get_item()`
- `POST /items` â†’ `create_item()`
- `PUT /items/{id}` â†’ `update_item()`
- `DELETE /items/{id}` â†’ `delete_item()`

### Services
- `get_all_*()` - List all items
- `get_*_by_id()` - Get single item
- `create_*()` - Create new item
- `update_*()` - Update existing item
- `delete_*()` - Delete item
- `search_*()` - Search with filters

### Repositories
- Same as services, but focused on data access

---

## ğŸ“‹ Numbering System

### Format: `PREFIX-YY-###`

| Entity | Prefix | Example |
|--------|--------|---------|
| Material Request | REQ | REQ-26-001 |
| Purchase Order | PO | PO-26-001 |
| RFQ | RFQ | RFQ-26-001 |
| Supplier Quotation | SQ | SQ-26-001 |

- `YY` = Last 2 digits of year (26 = 2026)
- `###` = Sequential number, resets annually
- Generated by: `/app/backend/app/utils/sequence_generator.py`

---

## ğŸ” Authentication

### JWT-based authentication
- Token in header: `Authorization: Bearer <token>`
- Token expiry: 24 hours
- Refresh: Not implemented (re-login required)

### Roles
| Role | Code | Access |
|------|------|--------|
| System Admin | `system_admin` | Full system access |
| Procurement Manager | `procurement_manager` | Orders, suppliers, catalog |
| General Manager | `general_manager` | Approvals, reports |
| Engineer | `engineer` | Request approval |
| Supervisor | `supervisor` | Create requests |
| Delivery Tracker | `delivery_tracker` | Track deliveries |
| Quantity Engineer | `quantity_engineer` | Buildings system |

---

## âš ï¸ Deprecated Files

Files in `/routes/pg_*.py` are **DEPRECATED** and should NOT be used:
- `pg_routes.py` - Legacy V1 routes
- Any file with `pg_` prefix

All new development should use `/routes/v2_*.py`

---

## ğŸ§ª Testing Guidelines

### Test file location
- `/app/backend/tests/`

### Test naming
```python
# Format: test_<scenario>_<expected_result>
def test_create_user_with_valid_data_returns_user():
    pass

def test_create_user_without_email_raises_error():
    pass
```

### Test isolation
- Each test should be independent
- Use fixtures for setup/teardown
- Don't rely on test execution order

---

## ğŸ“š API Versioning

### Current: V2 (`/api/v2/*`)
- All new development uses V2
- V1 (`/api/pg/*`) is deprecated

### Base URLs
- Development: `http://localhost:8001`
- Preview: From `REACT_APP_BACKEND_URL`

---

## ğŸ”„ Date/Time Standards

### Storage
- All timestamps stored in UTC
- Use `datetime.now(timezone.utc)` or `utc_now()` helper

### Serialization
- ISO 8601 format: `2026-01-19T09:30:00+00:00`
- Use `to_iso_string()` helper

### Display
- Convert to local timezone in frontend only

---

## ğŸ“ Error Handling

### HTTP Status Codes
| Code | Usage |
|------|-------|
| 200 | Success |
| 201 | Created |
| 400 | Bad Request (validation error) |
| 401 | Unauthorized (not logged in) |
| 403 | Forbidden (no permission) |
| 404 | Not Found |
| 500 | Internal Server Error |

### Error Response Format
```json
{
  "detail": "Error message in Arabic"
}
```

---

## ğŸ—‚ï¸ Directory Structure

```
/app/backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ config.py          # Configuration & helpers (utc_now, to_iso_string)
â”‚   â”œâ”€â”€ dependencies.py    # FastAPI dependencies
â”‚   â”œâ”€â”€ repositories/      # Data access layer
â”‚   â”‚   â”œâ”€â”€ admin_repository.py
â”‚   â”‚   â”œâ”€â”€ gm_repository.py      # NEW - GM data access
â”‚   â”‚   â”œâ”€â”€ reports_repository.py # NEW - Reports data access
â”‚   â”‚   â”œâ”€â”€ order_repository.py
â”‚   â”‚   â”œâ”€â”€ request_repository.py
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ services/          # Business logic layer
â”‚   â”‚   â”œâ”€â”€ admin_service.py
â”‚   â”‚   â”œâ”€â”€ gm_service.py         # NEW - GM business logic
â”‚   â”‚   â”œâ”€â”€ reports_service.py    # NEW - Reports business logic
â”‚   â”‚   â”œâ”€â”€ order_service.py
â”‚   â”‚   â”œâ”€â”€ request_service.py
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ utils/             # Utility functions
â”œâ”€â”€ database/
â”‚   â”œâ”€â”€ connection.py      # DB connection
â”‚   â””â”€â”€ models.py          # SQLAlchemy models
â”œâ”€â”€ routes/
â”‚   â””â”€â”€ v2_*.py            # V2 API routes (NO direct DB access)
â”œâ”€â”€ tests/                 # Test files
â””â”€â”€ server.py              # FastAPI app entry
```
